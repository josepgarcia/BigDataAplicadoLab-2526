.PHONY: help download-cache build up clean deep-clean shell-master

help: ## Mostrar esta ayuda
	@echo "Comandos disponibles para MÃ³dulo 2 Simple - Hadoop & Spark Single Node:"
	@echo ""
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | awk 'BEGIN {FS = ":.*?## "}; {printf "  \033[36m%-20s\033[0m %s\n", $$1, $$2}'
	@echo ""
	@echo "Ejemplos de uso:"
	@echo "  make download-cache  # Descargar paquetes al cachÃ© central (/downloads)"
	@echo "  make build           # Construir la imagen Docker"
	@echo "  make up              # Levantar el clÃºster Hadoop"
	@echo "  make test            # Ejecutar test MapReduce"

# Descargar Hadoop y Hive al cachÃ© local (acelera reconstrucciones)
download-cache: ## Descargar paquetes al cachÃ© central (/downloads)
	@echo "ğŸ“¦ Descargando archivos al cachÃ© local..."
	@cd Base && ./download-cache.sh

# Variables
# AutodetecciÃ³n de Docker Compose (V2 "docker compose" o V1 "docker-compose")
DOCKER_COMPOSE := $(shell \
    if docker compose version >/dev/null 2>&1; then echo "docker compose"; \
    elif command -v docker-compose >/dev/null 2>&1; then echo "docker-compose"; \
    else echo "docker compose"; fi)

# Construir las imÃ¡genes
build: ## Construir la imagen Docker
	@echo "ğŸ”¨ Construyendo imÃ¡genes Docker..."
	$(DOCKER_COMPOSE) build

# Levantar el clÃºster
up: ## Levantar el clÃºster Hadoop (1 nodo)
	@echo "ğŸš€ Levantando clÃºster Hadoop (1 nodo)..."
	$(DOCKER_COMPOSE) up -d
	@echo "â³ Esperando 20 segundos a que los servicios estÃ©n listos..."
	@for i in $$(seq 1 20); do \
		printf "\r["; \
		for j in $$(seq 1 20); do \
			if [ $$j -le $$i ]; then printf "â–ˆ"; else printf "â–‘"; fi; \
		done; \
		printf "] $$i/20s"; \
		sleep 1; \
	done; \
	echo ""
	@echo "âœ… ClÃºster levantado!"
	@echo "ğŸ“Š NameNode UI: http://localhost:9870"
	@echo "ğŸ“Š ResourceManager UI: http://localhost:8088"
	@echo "âš¡ Spark Master UI: http://localhost:8080"
	@echo "ğŸ““ Jupyter Notebook: http://localhost:8888"
	@echo "ğŸ“œ Spark History Server: http://localhost:18080"

clean: ## Limpiar contenedores, volÃºmenes y red
	@echo "ğŸ§¹ Limpiando contenedores, volÃºmenes y red del proyecto..."
	$(DOCKER_COMPOSE) down -v
	@echo "âœ… Limpieza completada!"
	@echo "ğŸ’¡ Para eliminar tambiÃ©n las imÃ¡genes usa: make deep-clean"


# Limpieza profunda: elimina ABSOLUTAMENTE TODO (contenedores, volÃºmenes, imÃ¡genes, red y cachÃ©)
deep-clean: ## Limpieza profunda (elimina contenedores, volÃºmenes, imÃ¡genes y red)
	@echo "ğŸ”¥ LIMPIEZA PROFUNDA - Eliminando recursos del proyecto..."
	@echo "âš ï¸  Esto eliminarÃ¡:"
	@echo "   - Contenedor del clÃºster Hadoop (master)"
	@echo "   - VolÃºmenes de datos del proyecto"
	@echo "   - ImÃ¡genes Docker del proyecto"
	@echo "   - Red del clÃºster"
	@echo "   - CachÃ© de build del proyecto"
	@echo ""
	@read -p "Â¿EstÃ¡s seguro? (s/N): " confirm && [ "$$confirm" = "s" ] || [ "$$confirm" = "S" ] || (echo "OperaciÃ³n cancelada" && exit 1)
	@echo ""
	@echo "ğŸ—‘ï¸  Deteniendo y eliminando contenedores y volÃºmenes del proyecto..."
	@$(DOCKER_COMPOSE) down -v 2>/dev/null || true
	@echo "ğŸ—‘ï¸  Eliminando imÃ¡genes del proyecto..."
	@docker rmi modulo2-master 2>/dev/null || true
	@echo "ğŸ—‘ï¸  Eliminando volÃºmenes del proyecto..."
	@docker volume rm modulo2_master-data 2>/dev/null || true
	@echo "ğŸ—‘ï¸  Eliminando red del proyecto..."
	@docker network rm modulo2_hadoop-net 2>/dev/null || true
	@echo "ğŸ—‘ï¸  Limpiando cachÃ© de build (solo capas no utilizadas)..."
	@docker buildx prune -f

# Ejecutar test MapReduce
test: ## Ejecutar test MapReduce (word count)
	@echo "ğŸ§ª Ejecutando test MapReduce..."
	@cd ejercicios && sh test_docker.sh

# Acceder al shell del master
shell-master: ## Acceder al shell del contenedor como usuario hadoop
	docker exec -it -u hadoop hadoop-master-simple bash
